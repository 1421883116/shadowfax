#!/usr/bin/env php
<?php

foreach ([__DIR__.'/../autoload.php', __DIR__.'/../../autoload.php', __DIR__.'/vendor/autoload.php'] as $file) {
    if (file_exists($file)) {
        $autoload = $file;

        break;
    }
}

if (! isset($autoload) || ! file_exists($autoload)) {
    fwrite(STDERR, 'Autoload not found'.PHP_EOL);

    die(1);
}

require $autoload;

$composer = new HuangYi\Shadowfax\Composer($autoload);

$shadowfax = new HuangYi\Shadowfax\Shadowfax(
    $_ENV['APP_BASE_PATH'] ?? __DIR__.'/../../..'
);

$config = new HuangYi\Shadowfax\Config(
    $_ENV['SHADOWFAX_CONFIG_PATH'] ?? __DIR__.'/../../../shadowfax.ini',
    $shadowfax
);

$shadowfax->instance(HuangYi\Shadowfax\Composer::class, $composer);
$shadowfax->instance(HuangYi\Shadowfax\Config::class, $config);

$shadowfax->addCommands([
    new HuangYi\Shadowfax\Console\StartCommand,
]);

unset($autoload, $composer, $config);

$shadowfax->run();
